unit Unit1;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants,
  System.Classes, Vcl.Graphics, Vcl.Controls, Vcl.Forms, Vcl.Dialogs,
  Vcl.ExtCtrls, Vcl.StdCtrls, System.Win.ScktComp;

type
  TForm1 = class(TForm)
    ComboBox1: TComboBox;
    Image1: TImage;
    StatusBar1: TStatusBar;
    Button1: TButton;
    Label1: TLabel;
    Timer1: TTimer;
    ServerSocket1: TServerSocket;
    procedure FormCreate(Sender: TObject);
    procedure Button1Click(Sender: TObject);
    procedure ComboBox1Change(Sender: TObject);
    procedure Timer1Timer(Sender: TObject);
    procedure ServerSocket1ClientConnect(Sender: TObject;
      Socket: TCustomWinSocket);
    procedure ServerSocket1ClientDisconnect(Sender: TObject;
      Socket: TCustomWinSocket);
    procedure ServerSocket1ClientRead(Sender: TObject;
      Socket: TCustomWinSocket);
  private
    { Private declarations }
    procedure HandleCommand(Socket: TCustomWinSocket; const aData: TBytes);
  public
    { Public declarations }
  end;

var
  Form1: TForm1;

implementation

{$R *.dfm}

procedure TForm1.Button1Click(Sender: TObject);
begin
  if Button1.Caption = 'Start Desktop Capture' then
  begin
    Button1.Caption := 'Stop Desktop Capture';
    Timer1.Enabled := true;
  end
  else
  begin
    Button1.Caption := 'Start Desktop Capture';
    Timer1.Enabled := false;
  end;
end;

procedure TForm1.ComboBox1Change(Sender: TObject);
begin
  StatusBar1.Panels[0].Text := 'Total Monitors: ' +
    IntToStr(ComboBox1.Items.Count);
end;

procedure TForm1.FormCreate(Sender: TObject);
begin
  ServerSocket1 := TServerSocket.Create(Self);
  ServerSocket1.Port := 3434;
  ServerSocket1.OnClientConnect := ServerSocket1ClientConnect;
  ServerSocket1.OnClientDisconnect := ServerSocket1ClientDisconnect;
  ServerSocket1.OnClientRead := ServerSocket1ClientRead;
  ServerSocket1.Active := true;
  ShowMessage('Server is active.');
end;

procedure TForm1.ServerSocket1ClientConnect(Sender: TObject;
  Socket: TCustomWinSocket);
begin
  Caption := Caption + ' | Client Connected!';
  Button1.Enabled := true;
  ShowMessage('Client connected.');
end;

procedure TForm1.ServerSocket1ClientDisconnect(Sender: TObject;
  Socket: TCustomWinSocket);
begin
  Timer1.Enabled := false;
  Button1.Enabled := false;
  ShowMessage('Client disconnected.');
end;

procedure TForm1.ServerSocket1ClientRead(Sender: TObject;
  Socket: TCustomWinSocket);
var
  buffer: array of Byte;
  bytesRead: Integer;
  ms: TMemoryStream;
  data: TBytes;
begin
  SetLength(buffer, 4096);
  ms := TMemoryStream.Create;
  try
    repeat
      bytesRead := Socket.ReceiveBuf(buffer[0], Length(buffer));
      if bytesRead > 0 then
        ms.Write(buffer[0], bytesRead);
    until bytesRead <= 0;

    if ms.Size > 0 then
    begin
      SetLength(data, ms.Size);
      ms.Position := 0;
      ms.ReadBuffer(data[0], ms.Size);
      HandleCommand(Socket, data);
    end;
  finally
    ms.Free;
  end;
end;

procedure TForm1.HandleCommand(Socket: TCustomWinSocket; const aData: TBytes);
var
  sl: TStringList;
  ms: TMemoryStream;
  bmp: TBitmap;
begin
  if Length(aData) = 0 then
    Exit;

  sl := TStringList.Create;
  try
    sl.Delimiter := '|';
    sl.StrictDelimiter := true;
    sl.DelimitedText := stringof(aData);

    if (sl.Count > 0) and (sl[0] = 'ScreenShot') then
    begin
      ms := TMemoryStream.Create;
      try
        ms.Write(aData[11], Length(aData) - 11);
        // Desloca o prefixo 'ScreenShot|'
        ms.Position := 0;
        bmp := TBitmap.Create;
        try
          bmp.LoadFromStream(ms);
          Image1.Picture.Bitmap := bmp;
        finally
          bmp.Free;
        end;
      finally
        ms.Free;
      end;
    end;
  finally
    sl.Free;
  end;
end;

procedure TForm1.Timer1Timer(Sender: TObject);
var
  I: Integer;
begin
  for I := 0 to ServerSocket1.Socket.ActiveConnections - 1 do
  begin
    ServerSocket1.Socket.Connections[I].SendText
      ('ScreenShot|' + IntToStr(ComboBox1.ItemIndex));
  end;
end;

end.
